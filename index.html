<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taglinks OCR Scanner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      max-width: 480px;
      margin: auto;
      padding: 1rem;
      background: #f9f9f9;
      color: #222;
    }
    video {
      width: 100%;
      height: auto;
      border-radius: 12px;
      background: black;
    }
    button, input[type=text] {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
    }
    button:disabled {
      background: #999;
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
      min-height: 1.4em;
    }
    #manualInput {
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>Taglinks OCR Scanner</h1>
  <p>Point your phone camera at the sticker (horizontal or vertical) and tap Scan. Or enter the code manually below.</p>

  <video id="video" autoplay playsinline></video>
  <button id="startBtn">Start Camera</button>
  <button id="stopBtn" disabled>Stop Camera</button>
  <button id="scanBtn" disabled>Scan</button>

  <div id="message"></div>

  <input type="file" accept="image/*" id="upload" />
  
  <div style="margin-top:1rem;">
    <input type="text" id="manualInput" placeholder="Enter code manually (e.g. ABC123)" />
    <button id="manualOpenBtn">Open Taglinks URL</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const scanBtn = document.getElementById('scanBtn');
    const message = document.getElementById('message');
    const upload = document.getElementById('upload');
    const manualInput = document.getElementById('manualInput');
    const manualOpenBtn = document.getElementById('manualOpenBtn');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let stream = null;

    function setMessage(msg) {
      message.textContent = msg;
    }

    function extractAlphanumeric(text) {
      if (!text) return '';
      const cleaned = text.replace(/[\s\-:_\n\r]+/g, ' ');
      const matches = cleaned.match(/[A-Z0-9]+/gi);
      if (!matches) return '';
      matches.sort((a, b) => b.length - a.length);
      return matches[0];
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, audio: false
        });
        video.srcObject = stream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        scanBtn.disabled = false;
        setMessage('Camera started.');
      } catch (e) {
        setMessage('Error accessing camera: ' + e.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      scanBtn.disabled = true;
      setMessage('Camera stopped.');
    }

    async function runOcrOnImage(img) {
      setMessage('Performing OCR...');
      try {
        // create Tesseract worker
        const worker = Tesseract.createWorker({
          logger: m => {
            if (m.status === 'recognizing text') {
              setMessage(`OCR progress: ${(m.progress * 100).toFixed(0)}%`);
            }
          }
        });
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
        });
        const { data: { text } } = await worker.recognize(img);
        await worker.terminate();
        return extractAlphanumeric(text);
      } catch (err) {
        setMessage('OCR error: ' + err.message);
        return '';
      }
    }

    async function scan() {
      if (!video.srcObject) {
        setMessage('Camera not started.');
        return;
      }
      // draw current frame to canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/png');

      // try OCR with original and rotated images (±90°) to handle vertical codes
      const img = new Image();
      img.src = dataUrl;
      await new Promise(r => img.onload = r);

      // original
      let code = await runOcrOnImage(img);
      if (!code) {
        // rotate 90 deg clockwise
        code = await runOcrOnImage(rotateImage(img, true));
      }
      if (!code) {
        // rotate 90 deg counterclockwise
        code = await runOcrOnImage(rotateImage(img, false));
      }

      if (code) {
        setMessage(`Code found: ${code}`);
        const url = `https://www.taglinks.co.za/pt${encodeURIComponent(code)}`;
        setTimeout(() => {
          window.location.href = url;
        }, 1200);
      } else {
        setMessage('No code found. Try again or enter manually.');
      }
    }

    // rotate image 90 degrees CW or CCW and return canvas as image
    function rotateImage(image, clockwise = true) {
      const offscreen = document.createElement('canvas');
      const ctxOff = offscreen.getContext('2d');
      offscreen.width = image.height;
      offscreen.height = image.width;

      if (clockwise) {
        ctxOff.translate(offscreen.width, 0);
        ctxOff.rotate(Math.PI / 2);
      } else {
        ctxOff.translate(0, offscreen.height);
        ctxOff.rotate(-Math.PI / 2);
      }
      ctxOff.drawImage(image, 0, 0);
      const rotatedImg = new Image();
      rotatedImg.src = offscreen.toDataURL();
      return rotatedImg;
    }

    upload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      setMessage('Running OCR on uploaded image...');
      const img = new Image();
      img.src = URL.createObjectURL(file);
      await new Promise(r => img.onload = r);

      // Try original and rotated
      let code = await runOcrOnImage(img);
      if (!code) {
        code = await runOcrOnImage(rotateImage(img, true));
      }
      if (!code) {
        code = await runOcrOnImage(rotateImage(img, false));
      }

      if (code) {
        setMessage(`Code found: ${code}`);
        const url = `https://www.taglinks.co.za/pt${encodeURIComponent(code)}`;
        setTimeout(() => {
          window.location.href = url;
        }, 1200);
      } else {
        setMessage('No code found in image.');
      }
    });

    manualOpenBtn.addEventListener('click', () => {
      const code = manualInput.value.trim().toUpperCase();
      if (!code) {
        setMessage('Please enter the code manually first.');
        return;
      }
      const url = `https://www.taglinks.co.za/pt${encodeURIComponent(code)}`;
      window.location.href = url;
    });

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    scanBtn.addEventListener('click', scan);
  </script>
</body>
</html>